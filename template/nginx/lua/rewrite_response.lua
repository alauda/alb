--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by cong.
--- DateTime: 2021/11/16 下午6:27

local common = require "utils.common"
local ngx_log = ngx.log
local ngx_err = ngx.ERR

local function trace(log)
    local enable = false
    if enable then
        ngx_log(ngx_err, "trace "..log())
    end
end

local _M = {}

function _M.header_filter()
    local ngx_header = ngx.header
    local matched_policy = ngx.ctx.matched_policy
    trace(function()
        return "rewrite_response: policy is " .. common.dump(matched_policy)
    end)
    -- fast return
    if not common.has_key(matched_policy, { "config", "rewrite_response"})
    then
        trace(function()
            return "rewrite_response: could not find config,just ignore"
        end)
        return
    end
	-- TODO implement more header set method
    local set_headers = matched_policy["config"]["rewrite_response"]["headers"]
	-- headers_set(headers) set header and values anywhere
	-- headers_remove remove header
	-- headers_update set header only when it exist
	-- headers_default set header only when it not exist

    for k, v in pairs(set_headers) do
        ngx_header[k] = v
    end
end

return _M