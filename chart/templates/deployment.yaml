kind: Deployment
apiVersion: apps/v1
spec:
  selector:
    matchLabels:
      service.{{ .Values.global.labelBaseDomain }}/name: deployment-{{ .Values.loadbalancerName }}
      service_name: alb2-{{ .Values.loadbalancerName }}
  replicas: {{ .Values.replicas }}
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
    type: RollingUpdate
  template:
    spec:
      shareProcessNamespace: true
      hostNetwork: true
      priorityClassName: system-node-critical
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  alb2.{{ .Values.global.labelBaseDomain }}/type: {{ .Values.antiAffinityKey }}
              topologyKey: kubernetes.io/hostname
      tolerations:
        - operator: Exists
      containers:
        - securityContext:
            capabilities:
              add:
                - SYS_PTRACE
          name: alb2
          image: "{{ .Values.global.registry.address }}/{{ .Values.global.images.alb2.repository }}:{{ .Values.global.images.alb2.tag }}"
          terminationMessagePolicy: File
          command:
            - /alb/ctl/run-alb.sh
          env:
            - name: MAX_TERM_SECONDS
              value: "{{ .Values.maxTermSeconds }}"
            - name: NAME
              value: {{ .Values.loadbalancerName }}
            - name: NAMESPACE
              value: {{ .Values.global.namespace }}
            - name: DOMAIN
              value: {{ .Values.global.labelBaseDomain }}
            - name: ENABLE_GC
              value: "{{ .Values.enableGC }}"
            - name: ENABLE_GC_APP_RULE
              value: "{{ .Values.enableGCAppRule }}"
            - name: ENABLE_PROMETHEUS
              value: "{{ .Values.enablePrometheus }}"
            - name: ENABLE_PORTPROBE
              value: "{{ .Values.enablePortprobe }}"
            - name: ENABLE_IPV6
              value: "{{ .Values.enableIPV6 }}"
            - name: ENABLE_HTTP2
              value: "{{ .Values.enableHTTP2 }}"
            - name: ENABLE_GZIP
              value: "{{ .Values.enableGzip }}"
            - name: SERVE_INGRESS
              value: "{{ .Values.enableIngress }}"
            - name: SERVE_CROSSCLUSTERS
              value: "{{ .Values.enableCrossClusters }}"
            - name: ENABLE_GO_MONITOR
              value: "{{ .Values.enableGoMonitor }}"
            - name: ENABLE_PROFILE
              value: "{{ .Values.enableProfile }}"
            - name: GO_MONITOR_PORT
              value: "{{ .Values.goMonitorPort }}"
            - name: DEFAULT-SSL-CERTIFICATE
              value: "{{ .Values.defaultSSLCert }}"
            - name: DEFAULT-SSL-STRATEGY
              value: "{{ .Values.defaultSSLStrategy }}"
            - name: INGRESS_HTTP_PORT
              value: "{{ .Values.ingressHTTPPort }}"
            - name: INGRESS_HTTPS_PORT
              value: "{{ .Values.ingressHTTPSPort }}"
            - name: WORKER_LIMIT
              value: "{{ .Values.workerLimit }}"
            - name: CPU_LIMIT
              value: "{{ .Values.resources.limits.cpu }}"
            - name: SCENARIO
              value: "{{ .Values.global.platformscenario }}"
            - name: RESYNC_PERIOD
              value: "{{ .Values.resyncPeriod }}"
            - name: METRICS_PORT
              value: "{{ .Values.metricsPort }}"
            - name: BACKLOG
              value: "{{ .Values.backlog }}"
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: ENABLE_GATEWAY
              value: "{{ .Values.gateway.enable }}"
            - name: POLICY_ZIP
              value: "{{ .Values.policyZip }}"

          imagePullPolicy: Always
          resources:
            limits:
              cpu: {{ .Values.resources.alb.limits.cpu }}
              memory: {{ .Values.resources.limits.memory }}
            requests:
              cpu: {{ .Values.resources.alb.requests.cpu }}
              memory: {{ .Values.resources.requests.memory }}
          volumeMounts:
          - name: tweak-conf
            mountPath: /alb/tweak/
          - name: share-conf
            mountPath: /etc/alb2/nginx/
        - name: nginx
          securityContext:
            capabilities:
              add:
                - SYS_RESOURCE
                - NET_BIND_SERVICE
          image: "{{ .Values.global.registry.address }}/{{ .Values.global.images.nginx.repository }}:{{ .Values.global.images.nginx.tag }}"
          imagePullPolicy: Always
          volumeMounts:
          - name: share-conf
            mountPath: /etc/alb2/nginx/
          - name: tweak-conf
            mountPath: /alb/tweak/
          env:
            - name: MAX_TERM_SECONDS
              value: "{{ .Values.maxTermSeconds }}"
            - name: NAME
            - name: SYNC_POLICY_INTERVAL
              value: "{{ .Values.syncPolicyInterval }}"
            - name: CLEAN_METRICS_INTERVAL
              value: "{{ .Values.cleanMetricsInterval}}"
            - name: NEW_POLICY_PATH
              value: /etc/alb2/nginx/policy.new
            - name: DEFAULT-SSL-STRATEGY
              value: "{{ .Values.defaultSSLStrategy }}"
            - name: INGRESS_HTTPS_PORT
              value: "{{ .Values.ingressHTTPSPort }}"
            - name: POLICY_ZIP
              value: "{{ .Values.policyZip }}"

          command:
            - /alb/nginx/boot-nginx.sh
          livenessProbe:
            httpGet:
              path: /status
              port: {{ .Values.metricsPort }}
            initialDelaySeconds: 60
            periodSeconds: 60
            failureThreshold: 5
            timeoutSeconds: 5
          resources:
            limits:
              cpu: {{ .Values.resources.limits.cpu }}
              memory: {{ .Values.resources.limits.memory }}
            requests:
              cpu: {{ .Values.resources.requests.cpu }}
              memory: {{ .Values.resources.requests.memory }}

      volumes:
      - name: tweak-conf
        configMap:
          name: {{ .Values.loadbalancerName }}
          items:
          - key: http
            path: http.conf
          - key: http_server
            path: http_server.conf
          - key: grpc_server
            path: grpc_server.conf
          - key: upstream
            path: upstream.conf
          - key: stream-tcp
            path: stream-tcp.conf
          - key: stream-udp
            path: stream-udp.conf
          - key: stream-common
            path: stream-common.conf
          - key: bind_nic
            path: bind_nic.json
      - name: share-conf
        emptyDir: { }
    metadata:
      annotations:
        values_hash:  {{ .Values | toYaml | sha256sum }}
      labels:
        alb2.{{ .Values.global.labelBaseDomain }}/type: {{ .Values.antiAffinityKey }}
        service.{{ .Values.global.labelBaseDomain }}/name: deployment-{{ .Values.loadbalancerName }}
        service_name: alb2-{{ .Values.loadbalancerName }}
        alb2.{{ .Values.global.labelBaseDomain }}/pod_type: alb2
        {{ .Values.global.labelBaseDomain }}/product: "Platform-Center"
metadata:
  name: {{ .Values.loadbalancerName }}
  namespace: {{ .Values.global.namespace }}
  labels:
    service_name: alb2-{{ .Values.loadbalancerName }}
